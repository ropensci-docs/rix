<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>z - Advanced topic: Running R or Shell Code in Nix from R • rix</title>
<!-- rOpenSci favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="z - Advanced topic: Running R or Shell Code in Nix from R">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v3.0.0/dist/cookieconsent.css">
<script src="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v3.0.0/dist/cookieconsent.umd.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">rix</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.15.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a-getting-started.html">a - Getting started</a></li>
    <li><a class="dropdown-item" href="../articles/b1-setting-up-and-using-rix-on-linux-and-windows.html">b1 - Setting up and using Nix and rix on Linux and Windows</a></li>
    <li><a class="dropdown-item" href="../articles/b2-setting-up-and-using-rix-on-macos.html">b2 - Setting up and using Nix and rix on macOS</a></li>
    <li><a class="dropdown-item" href="../articles/c-using-rix-to-build-project-specific-environments.html">c - Using rix to build project specific environments</a></li>
    <li><a class="dropdown-item" href="../articles/d1-installing-r-packages-in-a-nix-environment.html">d1 - Installing R packages in a Nix environment</a></li>
    <li><a class="dropdown-item" href="../articles/d2-installing-system-tools-and-texlive-packages-in-a-nix-environment.html">d2 - Installing system tools and TexLive packages in a Nix environment</a></li>
    <li><a class="dropdown-item" href="../articles/e-configuring-ide.html">e - Using an IDE with Nix shells</a></li>
    <li><a class="dropdown-item" href="../articles/f-renv2nix.html">f - Converting renv projects to Nix projects</a></li>
    <li><a class="dropdown-item" href="../articles/z-advanced-topic-building-an-environment-for-literate-programming.html">z - Advanced topic: Building an environment for literate programming</a></li>
    <li><a class="dropdown-item" href="../articles/z-advanced-topic-handling-packages-with-remote-dependencies.html">z - Advanced topic: Handling packages with remote dependencies</a></li>
    <li><a class="dropdown-item" href="../articles/z-advanced-topic-reproducible-analytical-pipelines-with-nix.html">z - Advanced topic: Reproducible Analytical Pipelines with Nix</a></li>
    <li><a class="dropdown-item" href="../articles/z-advanced-topic-running-r-or-shell-code-in-nix-from-r.html">z - Advanced topic: Running R or Shell Code in Nix from R</a></li>
    <li><a class="dropdown-item" href="../articles/z-advanced-topic-using-nix-inside-docker.html">z - Advanced topic: Using Nix inside Docker</a></li>
    <li><a class="dropdown-item" href="../articles/z-binary_cache.html">z - Advanced topic: Rolling out your own binary cache</a></li>
    <li><a class="dropdown-item" href="../articles/z-bleeding_edge.html">z - Advanced topic: Understanding the rPackages set release cycle and using bleeding edge packages</a></li>
    <li><a class="dropdown-item" href="../articles/z-contributing_to_nixpkgs.html">z - Advanced topic: Contributing to nixpkgs</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ropensci/rix/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>z - Advanced topic: Running R or Shell Code in Nix from R</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/rix/blob/master/vignettes/z-advanced-topic-running-r-or-shell-code-in-nix-from-r.Rmd" class="external-link"><code>vignettes/z-advanced-topic-running-r-or-shell-code-in-nix-from-r.Rmd</code></a></small>
      <div class="d-none name"><code>z-advanced-topic-running-r-or-shell-code-in-nix-from-r.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="testing-code-in-evolving-software-dependency-environments-with-confidence">
<strong>Testing code in evolving software dependency environments
with confidence</strong><a class="anchor" aria-label="anchor" href="#testing-code-in-evolving-software-dependency-environments-with-confidence"></a>
</h2>
<p>Adhering to sound versioning practices is crucial for ensuring the
reproducibility of software. Despite the expertise in software
engineering, the ever-growing complexity and continuous development of
new, potentially disruptive features present significant challenges in
maintaining code functionality over time. This pertains not only to
backward compatibility but also to future-proofing. When code handles
critical production loads and relies on numerous external software
libraries, it’s likely that these dependencies will evolve.
Infrastructure-as-code and other DevOps principles shine in addressing
these challenges. However, they may appear less approachable and more
labor-intensive to set up for the average R developer.</p>
<p>Are you ready to test your custom R functions and system commands in
a a different environment with isolated software builds that are both
pure at build and at runtime, without leaving the R console?</p>
<p>Let’s introduce <code><a href="../reference/with_nix.html">with_nix()</a></code>. <code><a href="../reference/with_nix.html">with_nix()</a></code> will
evaluate custom R code or shell commands with command line interfaces
provided by Nixpkgs in a Nix environment, and thereby bring the
read-eval-print-loop feeling. Not only can you evaluate custom R
functions or shell commands in Nix environments, but you can also bring
the results back to your current R session as R objects.</p>
</div>
<div class="section level2">
<h2 id="two-operational-modes-of-computations-in-environments-system-to-nix-and-nix-to-nix">
<strong>Two operational modes of computations in environments:
‘System-to-Nix’ and ‘Nix-to-Nix’</strong><a class="anchor" aria-label="anchor" href="#two-operational-modes-of-computations-in-environments-system-to-nix-and-nix-to-nix"></a>
</h2>
<p>We aim to accommodate various use cases, considering a gradient of
declarativity in individual or sets of software environments based on
personal preferences. There are two main modes for defining and
comparing code running through R and system commands (command line
interfaces; CLIs)</p>
<ol style="list-style-type: decimal">
<li>
<strong>‘System-to-Nix’</strong> environments: We assume that you
launch an R session with an R version defined on your host operating
system, either from the terminal or an integrated development
environment like RStudio. You need to make sure that you actively
control and know where you installed R and R packages from, and at what
versions. You may have interactively tested that your custom function
pipeline worked for the current setup. Most importantly, you want to
check whether you get your computations running and achieve identical
results when going back to a Nix revision that represent either newer or
also older versions of R and package sources.</li>
<li>
<strong>‘Nix-to-Nix’</strong> environments: Your goals of testing
code are the same as in 1., but you want more fine-grained control in
the source environment where you launch <code><a href="../reference/with_nix.html">with_nix()</a></code> from,
too. You are probably on the way of getting a passionate Nix user.</li>
</ol>
</div>
<div class="section level2">
<h2 id="case-study-1-evolution-of-base-r">
<strong>Case study 1: Evolution of base R</strong><a class="anchor" aria-label="anchor" href="#case-study-1-evolution-of-base-r"></a>
</h2>
<p>Carefully curated software improves over time, so does R. We pick an
example from the R changelog, the following <a href="https://cran.r-project.org/doc/manuals/r-release/NEWS.html" class="external-link">literal
entry in R 4.2.0</a>:</p>
<ul>
<li>“<code><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector()</a></code> gains a <code>data.frame</code> method
which returns a simple named list, also clearing a long standing ‘FIXME’
to enable <code>as.vector(&lt;data.frame&gt;, mode ="list")</code>. This
breaks code relying on <code>as.vector(&lt;data.frame&gt;)</code> to
return the unchanged data frame.”</li>
</ul>
<p>The goal is to illustrate this change in behavior from R versions
4.1.3 and before to R versions 4.2.0 and later.</p>
<div class="section level3">
<h3 id="setting-up-the-r-software-environment-with-nix">Setting up the (R) software environment with Nix<a class="anchor" aria-label="anchor" href="#setting-up-the-r-software-environment-with-nix"></a>
</h3>
<p>First, we write a <code>default.nix</code> file containing Nix
expressions that pin R version 4.1.3 from Nixpkgs.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://docs.ropensci.org/rix/">"rix"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">path_env_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"."</span>, <span class="st">"_env_1_R-4-1-3"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/rix.html">rix</a></span><span class="op">(</span></span>
<span>  r_ver <span class="op">=</span> <span class="st">"4.1.3"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  project_path <span class="op">=</span> <span class="va">path_env_1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The following expression is written to default.nix in the subfolder
<code>./_env_1_R-4-1-3/</code>.</p>
<pre><code>let
 pkgs = import (fetchTarball "https://github.com/rstats-on-nix/nixpkgs/archive/2022-04-19.tar.gz") {};
     
  system_packages = builtins.attrValues {
    inherit (pkgs) 
      glibcLocales
      nix
      R;
  };
  
in

pkgs.mkShell {
  LOCALE_ARCHIVE = if pkgs.system == "x86_64-linux" then "${pkgs.glibcLocales}/lib/locale/locale-archive" else "";
  LANG = "en_US.UTF-8";
   LC_ALL = "en_US.UTF-8";
   LC_TIME = "en_US.UTF-8";
   LC_MONETARY = "en_US.UTF-8";
   LC_PAPER = "en_US.UTF-8";
   LC_MEASUREMENT = "en_US.UTF-8";

  buildInputs = [    system_packages   ];
  
}</code></pre>
<p>This also includes a custom <code>.Rprofile</code> file that ensure
that this subshell will not load any packages installed to the user’s
library of packages.</p>
</div>
<div class="section level3">
<h3 id="defining-and-interactively-testing-custom-r-code-with-functions">Defining and interactively testing custom R code with
function(s)<a class="anchor" aria-label="anchor" href="#defining-and-interactively-testing-custom-r-code-with-functions"></a>
</h3>
<p>We now have set up the configuration for R 4.1.3 set up in a
<code>default.nix</code> file in the folder
<code>./_env_1_R-4-1-3</code>. Since you are sure you are using an R
version higher 4.2.0 available on your system, you can check what that
<code><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector.data.frame()</a></code> S3 method returns a list.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, b <span class="op">=</span> <span class="fl">4</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">df</span>, mode <span class="op">=</span> <span class="st">"list"</span><span class="op">)</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] 4 5 6</span></span></code></pre></div>
<p>This is different for R versions 4.1.3 and below, where you should
get an identical data frame back.</p>
</div>
<div class="section level3">
<h3 id="run-functioned-up-code-and-investigate-results-produced-in-pure-nix-rsoftware-environments">Run functioned up code and investigate results produced in pure Nix
Rsoftware environments<a class="anchor" aria-label="anchor" href="#run-functioned-up-code-and-investigate-results-produced-in-pure-nix-rsoftware-environments"></a>
</h3>
<p>To formally validate in a ‘System-to-Nix’ approach that the object
returned from <code><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector.data.frame()</a></code> is before
<code>R</code> &lt; 4.2.0, we define a function that runs the
computation above.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_as_vector</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, mode <span class="op">=</span> <span class="st">"list"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="op">(</span><span class="va">out_system_1</span> <span class="op">&lt;-</span> <span class="fu">df_as_vector</span><span class="op">(</span>x <span class="op">=</span> <span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $a</span></span>
<span><span class="co">#&gt; [1] 1 2 3</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; $b</span></span>
<span><span class="co">#&gt; [1] 4 5 6</span></span></code></pre></div>
<p>Then, we will evaluate this test code through a
<code>nix-shell</code> R session. This adds both build-time and run-time
purity with the declarative Nix software configuration we have made
earlier. <code><a href="../reference/with_nix.html">with_nix()</a></code> leverages the following principles
under the hood:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Computing on the Language:</strong> Manipulating language
objects using code.</p></li>
<li><p><strong>Static Code Analysis:</strong> Detecting global objects
and package environments in the function call stack of ‘expr’. This
involves utilizing essential functionality from the ‘codetools’ package,
which is recursively iterated.</p></li>
<li><p><strong>Serialization of Dependent R objects:</strong> Saving
them to disk and deserializing them back into the R session’s RAM via a
temporary folder. This process establishes isolation between two
distinct computational environments, accommodating both ‘System-to-Nix’
and ‘Nix-to-Nix’ computational modes. Simultaneously, it facilitates the
transfer of input arguments, dependencies across the call stack, and
outputs of <code>expr</code> between the Nix-R and the system’s R
sessions.</p></li>
</ol>
<p>This approach guarantees reproducible side effects and effectively
streams messages and errors into the R session. Thereby, the {sys}
package facilitates capturing standard outputs and errors as text output
messages. Please be aware that <code><a href="../reference/with_nix.html">with_nix()</a></code> will invoke
<code>nix-shell</code>, which will itself run <code>nix-build</code> in
case the Nix derivation (package) for R version 4.1.3 is not yet in your
Nix store. This will take a bit of time to get the cache. You will see
in your current R console the specific Nix paths that will be downloaded
and copied into your Nix store automatically.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># now run it in `nix-shell`; `with_nix()` takes care</span></span>
<span><span class="co"># of exporting global objects of `df_as_vector` recursively</span></span>
<span><span class="va">out_nix_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/with_nix.html">with_nix</a></span><span class="op">(</span></span>
<span>  expr <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu">df_as_vector</span><span class="op">(</span>x <span class="op">=</span> <span class="va">df</span><span class="op">)</span>, <span class="co"># wrap to avoid evaluation</span></span>
<span>  program <span class="op">=</span> <span class="st">"R"</span>,</span>
<span>  project_path <span class="op">=</span> <span class="va">path_env_1</span>,</span>
<span>  message_type <span class="op">=</span> <span class="st">"simple"</span> <span class="co"># you can do `"verbose"`, too</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># compare results of custom codebase with indentical</span></span>
<span><span class="co"># inputs and different software environments</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">out_system_1</span>, <span class="va">out_nix_1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># should return `FALSE` if your system's R versions in</span></span>
<span><span class="co"># current interactive R session is R &gt;= 4.2.0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="syntax-option-for-specifying-function-in-expr-argument-of-with_nix">Syntax option for specifying function in <code>expr</code> argument
of <code>with_nix()</code><a class="anchor" aria-label="anchor" href="#syntax-option-for-specifying-function-in-expr-argument-of-with_nix"></a>
</h3>
<p>In the previous code snippet we wrapped the top-level
<code>expr</code> function with <code>function()</code> or
<code>function(){}</code>. As an alternative, you can also provide
default arguments when assigning the function used as <code>expr</code>
input like this:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df_as_vector</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, mode <span class="op">=</span> <span class="st">"list"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then, you just supply the name of the function to evaluate with
default arguments.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_nix_1_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/with_nix.html">with_nix</a></span><span class="op">(</span></span>
<span>  expr <span class="op">=</span> <span class="va">df_as_vector</span>, <span class="co"># provide name of function</span></span>
<span>  program <span class="op">=</span> <span class="st">"R"</span>,</span>
<span>  project_path <span class="op">=</span> <span class="va">path_env_1</span>,</span>
<span>  message_type <span class="op">=</span> <span class="st">"simple"</span> <span class="co"># you can do `"verbose"`, too</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>It yields the same results.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">identical</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">out_nix_1</span>, <span class="va">out_nix_1_b</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="comparing-as-vector-data-frame-for-both-r-versions-4-1-3-and-4-2-0-from-nixpkgs">Comparing <code>as.vector.data.frame()</code> for both R versions
4.1.3 and 4.2.0 from Nixpkgs<a class="anchor" aria-label="anchor" href="#comparing-as-vector-data-frame-for-both-r-versions-4-1-3-and-4-2-0-from-nixpkgs"></a>
</h3>
<p>Here follows an example a <code>Nix-to-Nix</code> solution, with two
subshells to track the evolution of base R in this specific case. We can
verify the breaking changes in case study 1 in more declarative manner
when we use both R 4.1.3 and R 4.2.0 from Nixpkgs. Since we already have
defined R 4.1.3 in the <em><code>env</code></em><code>_1_R-4-1-3</code>
subshell, we can use it as a source environment where with_nix() is
launched from. Accordingly, we define the R 4.2.0 environment in a
<em><code>env</code></em><code>_1_2_R-4-2-0</code>using Nix via
<code><a href="../reference/rix.html">rix::rix()</a></code>. The latter environment will be the target
environment where <code>df_as_vector()</code> will be evaluated in.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://docs.ropensci.org/rix/">"rix"</a></span><span class="op">)</span></span>
<span><span class="va">path_env_1_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"."</span>, <span class="st">"_env_1_2_R-4-2-0"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/rix.html">rix</a></span><span class="op">(</span></span>
<span>  r_ver <span class="op">=</span> <span class="st">"4.2.0"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  project_path <span class="op">=</span> <span class="va">path_env_1_2</span>,</span>
<span>  shell_hook <span class="op">=</span> <span class="st">"R"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">path_env_1_2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="st">"default.nix"</span></span></code></pre>
<p>Now, initiate a new R session as development environment using
<code>nix-shell</code>. Open a new terminal at the current working
directory of your R session. The provided expression
<code>default.nix</code>. defines R 4.1.3 in a “subfolder per subshell”
approach. <code>nix-shell</code> will use the expression by
<code>default.nix</code> and prefer it over any other <code>.nix</code>
files, except when you put a <code>shell.nix</code> file in that folder,
which takes precedence.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="ex">nix-shell</span> <span class="at">--pure</span> ./_env_1_R-4-1-3</span></code></pre></div>
<p>After some time downloading caches and doing builds, you will enter
an R console session with R 4.1.3. You did not need to type in R first,
because we set up a R shell hook via <code><a href="../reference/rix.html">rix::rix()</a></code>. Next, we
define again the target function to test in R 4.2.0, too.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># current Nix-R session with R 4.1.3</span></span>
<span><span class="va">df_as_vector</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, mode <span class="op">=</span> <span class="st">"list"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="op">(</span><span class="va">out_nix_1</span> <span class="op">&lt;-</span> <span class="fu">df_as_vector</span><span class="op">(</span>x <span class="op">=</span> <span class="va">df</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_nix_1_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/with_nix.html">with_nix</a></span><span class="op">(</span></span>
<span>  expr <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu">df_as_vector</span><span class="op">(</span>x <span class="op">=</span> <span class="va">df</span><span class="op">)</span>,</span>
<span>  program <span class="op">=</span> <span class="st">"R"</span>,</span>
<span>  project_path <span class="op">=</span> <span class="va">path_env_1_2</span>,</span>
<span>  message_type <span class="op">=</span> <span class="st">"simple"</span> <span class="co"># you can do `"verbose"`, too</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>You can now formally compare the outputs of the computation of the
same code in R 4.1.3 vs. R 4.2.0 environments controlled by Nix.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">out_nix_1</span>, <span class="va">out_nix_1_2</span><span class="op">)</span></span>
<span><span class="co"># yields FALSE</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="case-study-2-breaking-changes-in-stringr-1-5-0">
<strong>Case study 2: Breaking changes in {stringr}
1.5.0</strong><a class="anchor" aria-label="anchor" href="#case-study-2-breaking-changes-in-stringr-1-5-0"></a>
</h2>
<p>We add one more layer to the reproducibility of the R ecosystem. User
libraries from CRAN or GitHub, one thing that makes R shine is the huge
collection of software packages available from the community.</p>
<p>There was a change introduce in {stringr} 1.5.0; in earlier versions,
this line of code:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">stringr</span><span class="fu">::</span><span class="fu">str_subset</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"a"</span><span class="op">)</span>, <span class="st">""</span><span class="op">)</span></span></code></pre></div>
<p>would return the character <code>"a"</code>. However, this behaviour
is unexpected: it really should return an error. This was addressed in
versions after 1.5.0:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_system_stringr</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>  expr <span class="op">=</span> <span class="op">{</span></span>
<span>    <span class="fu">stringr</span><span class="fu">::</span><span class="fu">str_subset</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"a"</span><span class="op">)</span>, <span class="st">""</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Since the code returns an error, we wrap it inside
<code><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch()</a></code> and return <code>NULL</code> instead of an error
(if we wouldn’t do that, this vignette could not compile!).</p>
<p>Let’s build a subshell with the latest version of R, but an older
version of <a href="https://stringr.tidyverse.org" class="external-link">stringr</a>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://docs.ropensci.org/rix/">"rix"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">path_env_stringr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"."</span>, <span class="st">"_env_stringr_1.4.1"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/rix.html">rix</a></span><span class="op">(</span></span>
<span>  r_ver <span class="op">=</span> <span class="st">"4.3.1"</span>,</span>
<span>  r_pkgs <span class="op">=</span> <span class="st">"stringr@1.4.1"</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  project_path <span class="op">=</span> <span class="va">path_env_stringr</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can now run the code in the subshell</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_nix_stringr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/with_nix.html">with_nix</a></span><span class="op">(</span></span>
<span>  expr <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu">str_subset</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"a"</span><span class="op">)</span>, <span class="st">""</span><span class="op">)</span>,</span>
<span>  program <span class="op">=</span> <span class="st">"R"</span>,</span>
<span>  project_path <span class="op">=</span> <span class="va">path_env_stringr</span>,</span>
<span>  message_type <span class="op">=</span> <span class="st">"simple"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here are the last few lines printed on screen:</p>
<pre><code>==&gt; `expr` succeeded!

### Finished code evaluation in `nix-shell` ###

* Evaluating `expr` in `nix-shell` returns:
[1] "a"</code></pre>
<p>Not only do we see the result of evaluating the code in the subshell,
we also have access to it: <code>out_nix_stringr</code> holds this
result.</p>
<p>We can now compare the two: the result of the code running in our
main session with the latest version of <a href="https://stringr.tidyverse.org" class="external-link">stringr</a> and the
result of the code running in the subshell with the old version of
<a href="https://stringr.tidyverse.org" class="external-link">stringr</a>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">out_system_stringr</span>, <span class="va">out_nix_stringr</span><span class="op">)</span></span></code></pre></div>
<p>As expected, the result is <code>FALSE</code>.</p>
</div>
<div class="section level2">
<h2 id="case-study-3-using-a-subshell-to-get-hard-to-install-dependencies">
<strong>Case study 3: Using a subshell to get hard to install
dependencies</strong><a class="anchor" aria-label="anchor" href="#case-study-3-using-a-subshell-to-get-hard-to-install-dependencies"></a>
</h2>
<p>Nix subshells are quite useful in cases where you need to use a
package that might be difficult to install, such as
<a href="https://github.com/apache/arrow/" class="external-link">arrow</a>, or other packages that must be compiled. Depending
on your operating system you need to compile <a href="https://github.com/apache/arrow/" class="external-link">arrow</a> from
source, which can be a frustrating experience, especially if you only
need it to load data and bring it down to a manageable size (using
<code>select()</code> and <code><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter()</a></code> for instance). This use
cases illustrates how to achieve this.</p>
<p>Let’s start by building a subshell that is based on a distinct
revision of <code>nixpkgs</code>, for which we know that arrow compiles
on both linux and macOS (darwin).</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://docs.ropensci.org/rix/">"rix"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">path_env_arrow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"env_arrow"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/rix.html">rix</a></span><span class="op">(</span></span>
<span>  r_ver <span class="op">=</span> <span class="st">"4.1.1"</span>,</span>
<span>  r_pkgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"arrow"</span><span class="op">)</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  project_path <span class="op">=</span> <span class="va">path_env_arrow</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This specific revision of R contains <a href="https://github.com/apache/arrow/" class="external-link">arrow</a> 13. Let’s
now suppose that you already have a script with some code to load and
transform some data using <a href="https://github.com/apache/arrow/" class="external-link">arrow</a>. It may look something
like this:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">arrow_cars</span> <span class="op">&lt;-</span> <span class="fu">arrow_table</span><span class="op">(</span><span class="va">cars</span><span class="op">)</span></span>
<span></span>
<span><span class="va">arrow_cars</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">speed</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>To run this code in a subshell, we recommend wrapping it inside a
function:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">arrow_script</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/apache/arrow/" class="external-link">arrow</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">arrow_cars</span> <span class="op">&lt;-</span> <span class="fu">arrow_table</span><span class="op">(</span><span class="va">cars</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">arrow_cars</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">speed</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Which we can then run in the subshell:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_nix_arrow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/with_nix.html">with_nix</a></span><span class="op">(</span></span>
<span>  expr <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu">arrow_script</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  program <span class="op">=</span> <span class="st">"R"</span>,</span>
<span>  project_path <span class="op">=</span> <span class="va">path_env_arrow</span>,</span>
<span>  message_type <span class="op">=</span> <span class="st">"simple"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This will run the function in the subshell, and its output will be
saved in the <code>out_nix_arrow</code> variable, for further
manipulation in your main shell/session.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>





  </body>
</html>
